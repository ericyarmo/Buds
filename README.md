# Buds v1.0 üåø

**Private cannabis memory journal with E2EE sharing for up to 12 friends**

Built on receipt-first, local-first, privacy-by-default principles.

---

## Project Status

**Current Build:** ‚úÖ Phase 10.3 Module 3 Complete | Core Sync Engine ‚úÖ
**Date:** January 4, 2026
**Version:** 1.0.0 (Beta)
**Bundle ID:** `app.getbuds.buds`

**Latest Milestone:** Phase 10.3 Module 3 Complete - Receipt Processing Pipeline ‚úÖ
**Status:** Core sync engine implemented, gap detection + queueing next
**Next Up:** Module 4 (Gap Detection & Queueing) ‚Üí Module 5 (Jar Creation with Sync)
**Goal:** Complete distributed jar sync ‚Üí TestFlight beta (20-50 users)

---

## Quick Start (Coding Agents)

### Essential Reading (In Order)

1. **[`PHASE_10.3_FINAL_SUMMARY.md`](./docs/planning/PHASE_10.3_FINAL_SUMMARY.md)** ‚Üê **START HERE**
   - Current roadmap: Crypto + distributed systems hardening
   - 50-70 hours of fixes before TestFlight
   - Complete module breakdown (0.1-10)

2. **[`PHASE_10.3_JAR_SYNC_HARDENED.md`](./docs/planning/PHASE_10.3_JAR_SYNC_HARDENED.md)**
   - Master implementation plan for jar sync
   - Distributed systems edge cases
   - Causal ordering, sequencing, tombstones

3. **[`PHASE_10.3_CRYPTO_ADDENDUM.md`](./docs/planning/PHASE_10.3_CRYPTO_ADDENDUM.md)**
   - All crypto blind spots & fixes
   - TOFU attack mitigations
   - Multi-device identity problem solved

4. **[`docs/CBOR_POLICY.md`](./docs/CBOR_POLICY.md)** ‚Üê **CRITICAL**
   - CBOR library pinning (Module 0.1 complete)
   - Golden tests prevent signature breaks
   - Lock to SwiftCBOR 0.4.5 forever

5. **[`CANONICALIZATION_SPEC.md`](./docs/CANONICALIZATION_SPEC.md)**
   - Receipt signing implementation
   - Unsigned preimage pattern
   - CBOR encoding rules

6. **[`DATABASE_SCHEMA.md`](./docs/DATABASE_SCHEMA.md)**
   - GRDB schema (current migration: v8)
   - Tables: jars, jar_members, local_receipts, ucr_headers, blobs, reactions
   - NEW (v8): processed_jar_receipts, jar_tombstones, jar_receipt_queue

7. **[`E2EE_DESIGN.md`](./docs/E2EE_DESIGN.md)**
   - X25519 key agreement + AES-256-GCM
   - Multi-device encryption
   - Verified in Phase 10

---

## Phase 10.3: Crypto + Distributed Systems Hardening

### ‚úÖ Completed Modules

**Module 0.1: CBOR Library Pinning (2-3h) ‚úÖ**
- Locked SwiftCBOR to 0.4.5 in Package.swift
- Created golden test: `CBORCanonicalityTests.swift`
- Prevents library updates from breaking all signatures
- See `docs/CBOR_POLICY.md` for policy

**Module 0.2: Phone-Based Identity (4-6h) ‚úÖ**
- DID = `did:phone:SHA256(phone + account_salt)` (not per-device)
- All devices with same phone = same DID
- Account salt generated by relay on first registration
- Solves multi-device identity problem

**Module 0.3: Deterministic Phone Encryption (3-4h) ‚úÖ**
- Client sends plaintext phone over HTTPS to relay
- Relay encrypts with AES-256-GCM server-side
- Nonce derived from SHA-256(phone).slice(0, 12) - deterministic
- Prevents rainbow table attacks
- Requires BOTH DB leak + secrets leak to expose phones
- Relay migrations: 0005 (account_salts), 0006 (encrypted_phone)

**Module 0.4: Dynamic Device Discovery (2-3h) ‚úÖ**
- Fetch unknown devices from relay on-demand
- Auto-pin new devices (updated TOFU)
- Warning toast: "New device detected, verify safety number"

**Module 0.5: Safety Number UI (1-2h) ‚úÖ**
- Generate safety number from DID + device pubkeys (canonical ordering)
- Show in Circle member detail view
- Optional TOFU verification for power users

**Module 0.6: Relay Infrastructure (4-5h) ‚úÖ**
- Relay envelope architecture (sequence NOT in signed bytes)
- CIDv1 compatibility (relay matches iOS exactly)
- Race-safe sequence assignment (retry + UNIQUE constraint)
- 4-layer security (CID, signature, auth, membership)
- Relay migrations: 0007 (jar_receipts + jar_members tables)

**Module 1: Receipt Types & Relay Integration (3-4h) ‚úÖ**
- 7 jar receipt payload structs WITHOUT sequence field
- CBOR canonicalization for jar receipts
- Relay API integration (storeJarReceipt, getJarReceipts)
- Client sends receipt ‚Üí relay assigns authoritative sequence
- Files: JarReceipts.swift, RelayClient+JarReceipts.swift

**Module 2: Database Migration v8 (2-3h) ‚úÖ**
- processed_jar_receipts table (replay protection)
- jar_tombstones table (deletion safety)
- jar_receipt_queue table (out-of-order queueing)
- Added columns to jars: last_sequence_number, parent_cid
- Stores relay-assigned sequences (not client-generated)

**Module 3: Receipt Processing Pipeline (4-5h) ‚úÖ**
- JarSyncManager: Core sync engine (~800 lines)
- JarTombstoneRepository: Deletion safety (~110 lines)
- 5-step processing pipeline: replay protection, tombstone check, verify, apply, mark
- 9 receipt handlers: jar.created, member_added, bud_shared, bud_deleted, jar_deleted, etc.
- CBOR decoding for all receipt types
- Deletion semantics: bud deletion propagates, jar deletion creates tombstone
- Module 1 extension: Added jar.bud_shared + jar.bud_deleted receipt types

### üîú Next Modules (Week 2)

**Module 4: Gap Detection & Queueing (4-5h)**
- Extend JarSyncManager with gap detection
- Sequence gap detection + backfill requests
- Queue out-of-order receipts
- Process queue when dependencies satisfied

**Module 5: Jar Creation with Sync (2-3h)**
- Generate jar.created receipt WITHOUT sequence
- Send to relay ‚Üí store relay-assigned sequence
- Process jar.created on receive

**Module 6-10: Jar Sync Flows (12-16h)**
- Member invite flow, bud sharing, offline hardening, UI, polish

### Architecture Changes (Phase 10.3)

**Identity Model:**
- OLD: Each device = unique DID (multi-device broken)
- NEW: Phone-based DID, shared across devices

**Phone Storage:**
- OLD: SHA-256 hash (rainbow tables possible)
- NEW: AES-256-GCM encrypted (deterministic for lookups)

**CBOR Stability:**
- OLD: Unlocked SwiftCBOR dependency
- NEW: Locked to 0.4.5 with golden tests

**Distributed Systems (Relay Envelope Architecture):**
- OLD: Client assigns sequence numbers (race conditions possible)
- NEW: Relay assigns authoritative sequences (conflict-free)
- Client sends receipt WITHOUT sequence ‚Üí relay assigns ‚Üí client stores
- Sequence numbers for gap detection
- Tombstones for deletion safety
- Replay protection (processed_jar_receipts table)
- Causal ordering with parentCID chains (optional metadata)

---

## Current Architecture (Dec 31, 2025)

### Receipt-Based Data Model (IMMUTABLE)

Every event is a signed, content-addressed receipt:

```swift
struct UCRHeader {
    let cid: String              // CIDv1 (dag-cbor, sha2-256)
    let did: String              // Author DID (now phone-based!)
    let parentCID: String?       // Edit chain parent (CAUSAL TRUTH)
    let rootCID: String          // First version in chain
    let receiptType: String      // app.buds.session.created/v1
    let payload: ReceiptPayload  // Strongly-typed (contains claimed_time_ms)
    let signature: String        // Ed25519 (base64)
}
```

**Key Principle:** Causality (parentCID) = truth. Time (claimed_time_ms) = claim.

**CRUD Pattern:**
```swift
// Create
let receipt = try await receiptManager.create(payload: payload)

// Read
let memory = try await memoryRepository.fetch(id: uuid)

// Update (creates NEW receipt with same UUID)
let updated = try await receiptManager.update(uuid: uuid, newPayload: newPayload)

// Delete (soft delete, receipt remains)
try await receiptManager.delete(uuid: uuid)
```

**Why Immutable:** Enables E2EE verification, conflict-free sync, audit trails.

---

### Jar-Centric Model

**Schema:**
```
User has N Jars
Jar has N Members (max 12)
Jar has N Buds (unlimited)
Bud belongs to exactly 1 Jar
```

**Critical Rule:** One bud = one jar. No multi-jar buds.

**Jar Types:**
1. **Solo**: Auto-created, single-user, cannot delete
2. **Shared**: Multi-user (2-12), can delete (buds move to Solo)

---

## Tech Stack

| Component | Technology | Why |
|-----------|-----------|-----|
| Language | Swift 6 | Latest features, concurrency |
| UI | SwiftUI | Declarative, native performance |
| Database | GRDB | Production SQLite wrapper |
| Crypto | CryptoKit | Apple native (Ed25519, X25519, AES) |
| Auth | Firebase Auth | Phone verification |
| Backend | Cloudflare Workers | Edge compute, E2EE relay |
| Storage | Cloudflare R2 | Object storage for encrypted payloads |
| CBOR | SwiftCBOR 0.4.5 | **LOCKED** - Never upgrade (golden tests) |

---

## What's Working (Phases 1-10.2 Complete)

### ‚úÖ Core Infrastructure
- E2EE encryption (X25519 + AES-256-GCM)
- Receipt-based data model (immutable, verifiable)
- GRDB database (migration v7)
- Blob storage for images
- Multi-device sync with phone-based identity
- Cloudflare relay (production deployed)

### ‚úÖ Features
- Phone auth (Firebase)
- Create bud flow (simplified: name + type)
- Jar system (Solo + Shared, max 12 members)
- Jar CRUD (create, delete, view)
- Member management (add, remove, roles)
- Shelf grid view (home)
- Memory list cards (lightweight, <40MB)
- Edit, delete, reactions
- Pull-to-refresh
- Toast notifications
- Haptic feedback

### ‚úÖ E2EE Sharing (Phase 10.2)
- **Send buds**: Share encrypted buds to jar members
- **Real-time receive**: 30s polling interval, buds appear automatically
- **UI updates**: Jar stats and memory lists refresh on new arrivals

### ‚úÖ Crypto Hardening (Phase 10.3 Modules 0.1-0.3)
- **CBOR Pinning**: Locked to 0.4.5, golden tests prevent breaks
- **Phone-Based Identity**: Same phone = same DID across devices
- **Deterministic Phone Encryption**: Server-side AES-256-GCM prevents rainbow tables

### ‚úÖ Design System
- BudsColors, BudsTypography, BudsSpacing
- Dark mode throughout
- Consistent UI components

---

## Phase History (Summary)

| Phase | Status | What Was Built |
|-------|--------|----------------|
| **1-7** | ‚úÖ Complete | Foundation (Auth, E2EE, Receipts, DB, Images, Relay, Signatures) |
| **8** | ‚úÖ Complete | Jar Model (migrated from Circle, added jars + jar_members tables) |
| **9a** | ‚úÖ Complete | Jar Management (CRUD, member management, roles) |
| **9b** | ‚úÖ Complete | Shelf View (grid layout, replaced Timeline) |
| **10** | ‚úÖ Complete | Production Hardening (E2EE verified, memory optimized, toast, haptics) |
| **10.1** | ‚úÖ Complete | Beta Readiness (simplified UX, reactions, polish) |
| **10.2** | ‚úÖ Complete | Sharing Fix (foreground polling, real-time inbox) |
| **10.3** | üîÑ In Progress | Crypto + Distributed Systems Hardening (Modules 0.1-0.3 done, 0.4-10 remaining) |
| **11-14** | üîú Planned | Map, Shop, AI, App Store Prep (after Phase 10.3) |

**See [`PHASE_10.3_FINAL_SUMMARY.md`](./docs/planning/PHASE_10.3_FINAL_SUMMARY.md) for complete details.**

---

## Development Setup

### 1. Clone & Open

```bash
git clone <repo_url>
cd Buds
open Buds.xcodeproj
```

### 2. Install Dependencies (SPM)

- **GRDB**: `https://github.com/groue/GRDB.swift`
- **Firebase**: `https://github.com/firebase/firebase-ios-sdk`
- **SwiftCBOR**: `https://github.com/unrelenting-technology/SwiftCBOR` (locked to 0.4.5)

### 3. Configure Services

- Firebase project (phone auth + push)
- Cloudflare Workers account (relay server)
- See [`buds-relay/README.md`](../buds-relay/README.md) for relay setup

### 4. Build & Run

```bash
# Clean build
Cmd+Shift+K

# Build
Cmd+B

# Run on simulator
Cmd+R
```

---

## Security & Privacy

**Threat Model:** See [`PRIVACY_ARCHITECTURE.md`](./docs/PRIVACY_ARCHITECTURE.md)

**Key Principles:**
- E2EE for jar sharing (server sees only ciphertext)
- Local-first (data never leaves device unless shared)
- Location OFF by default
- No PII in receipts (DIDs are cryptographic, not personal)
- Multi-device support with phone-based identity
- Deterministic phone encryption prevents rainbow tables

**Crypto Hardening (Phase 10.3):**
- ‚úÖ CBOR library pinned (prevents signature breaks)
- ‚úÖ Phone-based identity (fixes multi-device DID problem)
- ‚úÖ Deterministic phone encryption (prevents rainbow table attacks)
- üîú Dynamic device discovery (handles new devices)
- üîú Safety number verification (optional TOFU verification)
- ‚ö™ Forward secrecy limitation documented (defer to Phase 12)
- ‚ö™ Metadata leakage accepted (relay sees who messages who)

**E2EE Verification:** ‚úÖ Tested in Phase 10 - Signatures remain valid after jar deletion.

---

## Documentation

All planning docs organized in `docs/` folder:

- **`docs/planning/`** - Phase plans, implementation guides
  - `PHASE_10.3_FINAL_SUMMARY.md` - Current roadmap
  - `PHASE_10.3_JAR_SYNC_HARDENED.md` - Master implementation plan
  - `PHASE_10.3_CRYPTO_ADDENDUM.md` - All crypto fixes
  - `PHASE_10.3_EDGE_CASE_AUDIT.md` - Distributed systems edge cases
- **`docs/architecture/`** - Core architecture docs
  - `BUDS_CRYPTO_KEY_MAP.md` - Complete crypto key inventory
  - `CANONICALIZATION_SPEC.md` - Receipt signing spec
  - `E2EE_DESIGN.md` - Encryption design
  - `DATABASE_SCHEMA.md` - GRDB schema
- **`docs/design/`** - UI/UX design docs
- **`docs/features/`** - Feature specifications
- **`docs/testing/`** - Test plans and results
- **`docs/`** - Root-level docs
  - `CBOR_POLICY.md` - CBOR library pinning policy
  - `README.md` - Docs index
  - `TESTFLIGHT_NOTES.md` - Beta testing notes

---

## Legal

- **Age:** 21+ only (federally illegal in US)
- **Disclaimer:** No medical advice, no sales facilitation
- **Privacy:** GDPR/CCPA-compliant design

---

## Roadmap

**Current Focus:** Phase 10.3 - Crypto + Distributed Systems Hardening (~24-33 hours remaining)

**Completed (Modules 0.1-3):**
- ‚úÖ Module 0.1: CBOR pinning
- ‚úÖ Module 0.2: Phone-based identity
- ‚úÖ Module 0.3: Deterministic phone encryption
- ‚úÖ Module 0.4: Dynamic device discovery
- ‚úÖ Module 0.5: Safety number UI
- ‚úÖ Module 0.6: Relay infrastructure (relay envelope architecture)
- ‚úÖ Module 1: Receipt types & relay integration (9 receipt types + bud deletion)
- ‚úÖ Module 2: Database migration v8 (jar receipt tables)
- ‚úÖ Module 3: Receipt processing pipeline (core sync engine, 9 handlers, tombstones)

**In Progress (Modules 4-10):**
- üîú Module 4: Gap detection & queueing (4-5h)
- üîú Module 5: Jar creation with sync (2-3h)
- üîú Module 6: Member invite flow (4-5h)
- üîú Module 7: Bud sharing with jar_id (2-3h)
- üîú Module 8: Offline hardening (3-4h)
- üîú Module 9: UI components (3-4h)
- üîú Module 10: Notifications & polish (2-3h)

**Week 3:** Integration & testing
- üîú Multi-device testing
- üîú Edge case testing
- üîú Bug fixes + polish

**Then:**
- TestFlight beta with 20-50 real users
- Gather feedback ‚Üí Iterate
- App Store launch

**Goal:** Build defensible, coherent distributed system + crypto. Ship right.

---

## Contributing

Private project. Architecture by Claude (Anthropic) + Eric.

---

## Build Progress Tracker

**Last Updated:** January 4, 2026
**Current Phase:** Phase 10.3 Module 3 Complete ‚úÖ
**Latest Commit:** Phase 10.3 Module 3 - Receipt Processing Pipeline

**Status:** Core sync engine implemented (Modules 0.1-3 complete, 7 modules remaining)
**Next Session:** Module 4 (Gap Detection & Queueing)
**Estimated Time to Beta:** 24-33 hours remaining

---

**For detailed implementation context, always start with [`PHASE_10.3_FINAL_SUMMARY.md`](./docs/planning/PHASE_10.3_FINAL_SUMMARY.md)**
